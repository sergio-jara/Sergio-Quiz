name: Unit Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2.0'
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.5'
        bundler-cache: true
        
    - name: Install dependencies
      run: |
        bundle install
        
    - name: Install CocoaPods
      run: |
        bundle exec pod install --repo-update
        
    - name: Run Unit Tests with Coverage
      run: |
        bundle exec fastlane github_actions
        
    - name: Generate Coverage Report
      run: |
        xcrun xccov view --report test_output/dynamox.xcresult > test_output/coverage.txt
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: test_output/
        retention-days: 7
        
    - name: Comment Coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const coverage = fs.readFileSync('test_output/coverage.txt', 'utf8');
            const lines = coverage.split('\n');
            const summaryLine = lines.find(line => line.includes('Total Coverage:'));
            
            if (summaryLine) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ“Š Test Coverage Report\n\n\`\`\`\n${summaryLine}\n\`\`\`\n\nğŸ“ Full report available in [test artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              });
            }
          } catch (error) {
            console.log('Could not read coverage file:', error.message);
          }
